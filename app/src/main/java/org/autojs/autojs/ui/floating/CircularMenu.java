package org.autojs.autojs.ui.floating;

import android.content.Context;
import android.content.res.ColorStateList;
import android.content.res.Configuration;
import android.text.TextUtils;
import android.view.ContextThemeWrapper;
import android.view.View;

import androidx.annotation.NonNull;

import com.afollestad.materialdialogs.MaterialDialog;
import com.makeramen.roundedimageview.RoundedImageView;

import org.autojs.autojs.AutoJs;
import org.autojs.autojs.app.AppLevelThemeDialogBuilder;
import org.autojs.autojs.app.CircularMenuOperationDialogBuilder;
import org.autojs.autojs.app.DialogUtils;
import org.autojs.autojs.core.accessibility.AccessibilityTool;
import org.autojs.autojs.core.accessibility.LayoutInspector;
import org.autojs.autojs.core.accessibility.NodeInfo;
import org.autojs.autojs.core.activity.ActivityInfoProvider;
import org.autojs.autojs.core.record.GlobalActionRecorder;
import org.autojs.autojs.core.record.Recorder;
import org.autojs.autojs.model.explorer.ExplorerDirPage;
import org.autojs.autojs.model.explorer.Explorers;
import org.autojs.autojs.model.script.Scripts;
import org.autojs.autojs.pref.Language;
import org.autojs.autojs.pref.Pref;
import org.autojs.autojs.tool.Func1;
import org.autojs.autojs.ui.enhancedfloaty.FloatyService;
import org.autojs.autojs.ui.enhancedfloaty.FloatyWindow;
import org.autojs.autojs.ui.explorer.ExplorerView;
import org.autojs.autojs.ui.floating.layoutinspector.LayoutBoundsFloatyWindow;
import org.autojs.autojs.ui.floating.layoutinspector.LayoutHierarchyFloatyWindow;
import org.autojs.autojs.ui.main.MainActivity;
import org.autojs.autojs.util.ClipboardUtils;
import org.autojs.autojs.util.RootUtils;
import org.autojs.autojs.util.ViewUtils;
import org.autojs.autojs.util.WorkingDirectoryUtils;
import com.tencent.apphelper.R;
import com.tencent.apphelper.databinding.CircularActionMenuBinding;
import org.greenrobot.eventbus.EventBus;
import org.jdeferred.Deferred;
import org.jdeferred.impl.DeferredObject;
import org.jetbrains.annotations.NotNull;

import java.text.MessageFormat;

/**
 * Created by Stardust on Oct 18, 2017.
 */
public class CircularMenu implements Recorder.OnStateChangedListener, LayoutInspector.CaptureAvailableListener {

    public record StateChangeEvent(int currentState, int previousState) {
        /* Empty record body. */
    }

    public static final int STATE_CLOSED = -1;
    public static final int STATE_NORMAL = 0;
    public static final int STATE_RECORDING = 1;

    CircularMenuWindow mWindow;

    private int mState;
    private RoundedImageView mActionViewIcon;
    private final Context mContext;
    private final GlobalActionRecorder mRecorder;
    private CircularActionMenuBinding binding;
    private MaterialDialog mSettingsDialog;
    private MaterialDialog mLayoutInspectDialog;
    private String mRunningPackage, mRunningActivity;
    private Deferred<NodeInfo, Void, Void> mCaptureDeferred;
    private final AccessibilityTool.Service mA11yToolService;

    public CircularMenu(Context context) {
        // mContext = new ContextThemeWrapper(context, R.style.AppTheme);
        mContext = context;
        initFloaty();
        setupWindowListeners();
        mRecorder = GlobalActionRecorder.getSingleton(context);
        mRecorder.addOnStateChangedListener(this);
        AutoJs.getInstance().getLayoutInspector().addCaptureAvailableListener(this);
        mA11yToolService = new AccessibilityTool(mContext).getService();
    }

    private void setupWindowListeners() {
        mWindow.setOnActionViewClickListener(v -> {
            if (isRecording()) {
                stopRecord();
            } else if (mWindow.isExpanded()) {
                mWindow.collapse();
            } else {
                mCaptureDeferred = new DeferredObject<>();
                AutoJs.getInstance().getLayoutInspector().captureCurrentWindow();
                mWindow.expand();
            }
        });
    }

    private void setupBindingListeners() {
        binding.scriptList.setOnClickListener(v -> {
            mWindow.collapse();
            ExplorerView explorerView = new ExplorerView(mContext);
            explorerView.setExplorer(Explorers.workspace(), ExplorerDirPage.createRoot(WorkingDirectoryUtils.getPath()));
            explorerView.setDirectorySpanSize(2);
            final MaterialDialog dialog = new AppLevelThemeDialogBuilder(mContext)
                    .title(mContext.getString(R.string.text_run_script))
                    .customView(explorerView, false)
                    .positiveText(mContext.getString(R.string.text_cancel))
                    .cancelable(false)
                    .build();
            explorerView.setOnItemOperateListener(item -> dialog.dismiss());
            explorerView.setOnItemClickListener((view, item) -> Scripts.run(mContext, item.toScriptFile()));
            explorerView.setOnProjectToolbarOperateListener(toolbar -> dialog.dismiss());
            explorerView.setOnProjectToolbarClickListener(toolbar -> toolbar.findViewById(R.id.project_run).performClick());
            explorerView.setProjectToolbarRunnableOnly(true);

            DialogUtils.adaptToExplorer(dialog, explorerView);
            DialogUtils.showDialog(dialog);
        });
        binding.record.setOnClickListener(v -> {
            mWindow.collapse();
            if (!RootUtils.isRootAvailable()) {
                DialogUtils.showDialog(new AppLevelThemeDialogBuilder(mContext)
                        .title(mContext.getString(R.string.text_no_root_access))
                        .content(mContext.getString(R.string.no_root_access_for_record))
                        .positiveText(mContext.getString(R.string.dialog_button_quit))
                        .build());
            } else {
                mRecorder.start();
            }
        });
        binding.layoutInspect.setOnClickListener(v -> {
            mWindow.collapse();
            inspectLayout(rootNode -> new LayoutBoundsFloatyWindow(rootNode, mContext));
        });
        binding.layoutInspect.setOnLongClickListener(v -> {
            mWindow.collapse();
            mLayoutInspectDialog = new CircularMenuOperationDialogBuilder(mContext)
                    .item(R.drawable.ic_circular_menu_bounds, mContext.getString(R.string.text_inspect_layout_bounds), v1 -> {
                        mWindow.collapse();
                        inspectLayout(rootNode -> new LayoutBoundsFloatyWindow(rootNode, mContext));
                    })
                    .item(R.drawable.ic_circular_menu_hierarchy, mContext.getString(R.string.text_inspect_layout_hierarchy), v1 -> {
                        mWindow.collapse();
                        inspectLayout(rootNode -> new LayoutHierarchyFloatyWindow(rootNode, mContext));
                    })
                    .title(mContext.getString(R.string.text_inspect_layout))
                    .build();
            DialogUtils.showDialog(mLayoutInspectDialog);
            return true;
        });
        binding.stopAllScripts.setOnClickListener(v -> {
            mWindow.collapse();
            if (AutoJs.getInstance().getScriptEngineService().stopAllAndToast() <= 0) {
                ViewUtils.showToast(mContext, mContext.getString(R.string.text_no_scripts_to_stop_running));
            }
        });
        binding.actionMenuMore.setOnClickListener(v -> {
            mWindow.collapse();

            if (mSettingsDialog != null && mSettingsDialog.isShowing()) {
                mSettingsDialog.dismiss();
            }

            ActivityInfoProvider infoProvider = AutoJs.getInstance().getInfoProvider();
            mRunningPackage = infoProvider.getLatestPackageByUsageStatsIfGranted();
            mRunningActivity = infoProvider.getLatestActivity();

            mSettingsDialog = new CircularMenuOperationDialogBuilder(mContext)
                    .item(R.drawable.ic_accessibility_black_48dp, mContext.getString(R.string.text_manage_a11y_service), v1 -> {
                        dismissSettingsDialog();
                        getAccessibilityTool().getService().launchSettings();
                    })
                    .item(R.drawable.ic_text_fields_black_48dp, mContext.getString(R.string.text_latest_package) + ":\n" + getRunningPackage(), v1 -> {
                        dismissSettingsDialog();
                        if (!TextUtils.isEmpty(mRunningPackage)) {
                            ClipboardUtils.setClip(mContext, mRunningPackage);
                            ViewUtils.showToast(mContext, getTextAlreadyCopied(R.string.text_latest_package));
                        }
                    })
                    .item(R.drawable.ic_text_fields_black_48dp, mContext.getString(R.string.text_latest_activity) + ":\n" + getRunningActivity(), v1 -> {
                        dismissSettingsDialog();
                        if (!TextUtils.isEmpty(mRunningActivity)) {
                            ClipboardUtils.setClip(mContext, mRunningActivity);
                            ViewUtils.showToast(mContext, getTextAlreadyCopied(R.string.text_latest_activity));
                        }
                    })
                    .item(R.drawable.ic_home_black_48dp, mContext.getString(R.string.text_open_main_activity), v1 -> {
                        dismissSettingsDialog();
                        MainActivity.launch(mContext);
                    })
                    .item(R.drawable.ic_control_point_black_48dp, mContext.getString(R.string.text_pointer_location), v1 -> {
                        dismissSettingsDialog();
                        if (!RootUtils.togglePointerLocation()) {
                            ViewUtils.showToast(mContext, mContext.getString(R.string.text_pointer_location_toggle_failed_with_hint), true);
                        }
                    })
                    .item(R.drawable.ic_close_white_48dp, mContext.getString(R.string.text_close_floating_button), v1 -> closeAndSaveState(false))
                    .title(mContext.getString(R.string.text_more))
                    .build();

            DialogUtils.showDialog(mSettingsDialog);
        });
    }

    public boolean isRecording() {
        return mState == STATE_RECORDING;
    }

    private void initFloaty() {
        mWindow = new CircularMenuWindow(new CircularMenuFloaty() {
            @Override
            public CircularActionView inflateActionView(FloatyService service, CircularMenuWindow window) {
                CircularActionView actionView = (CircularActionView) View.inflate(service, R.layout.circular_action_view, null);
                mActionViewIcon = actionView.findViewById(R.id.icon);
                return actionView;
            }

            @Override
            public CircularActionMenu inflateMenuItems(FloatyService service, CircularMenuWindow window) {
                CircularActionMenu menu = (CircularActionMenu) View.inflate(new ContextThemeWrapper(service, R.style.AppTheme), R.layout.circular_action_menu, null);
                binding = CircularActionMenuBinding.bind(menu);
                setupBindingListeners();
                return menu;
            }
        });
        mWindow.setKeepToSideHiddenWidthRadio(0.25f);
        FloatyService.addWindow(mWindow);
    }

    private void setState(int state) {
        int previousState = mState;

        mState = state;
        mActionViewIcon.setImageResource(isRecording()
                ? R.drawable.ic_ali_record
                : R.drawable.autojs6_material);
        mActionViewIcon.setBackgroundTintList(ColorStateList.valueOf(mContext.getColor(isRecording()
                ? R.color.circular_menu_icon_red
                : R.color.circular_menu_icon_white)));
        int padding = (int) mContext.getResources().getDimension(isRecording()
                ? R.dimen.padding_circular_menu_recording
                : R.dimen.padding_circular_menu_normal);
        mActionViewIcon.setPadding(padding, padding, padding, padding);

        EventBus.getDefault().post(new StateChangeEvent(mState, previousState));
    }

    public void stopRecord() {
        mRecorder.stop();
    }

    private void inspectLayout(Func1<NodeInfo, FloatyWindow> windowCreator) {
        if (mLayoutInspectDialog != null) {
            mLayoutInspectDialog.dismiss();
            mLayoutInspectDialog = null;
        }
        if (!mA11yToolService.isRunning()) {
            if (!mA11yToolService.start(false)) {
                ViewUtils.showToast(mContext, mContext.getString(R.string.error_no_accessibility_permission_to_capture));
                getAccessibilityTool().launchSettings();
            }
        } else {
            mCaptureDeferred.promise().then(capture -> {
                mActionViewIcon.post(() -> FloatyService.addWindow(windowCreator.call(capture)));
            });
        }
    }

    public void closeAndSaveState(boolean state) {
        Pref.putBooleanSync(R.string.key_floating_menu_shown, state);
        savePosition();
        close();
    }

    public void savePosition() {
        mWindow.savePosition();
    }

    public void savePosition(@NotNull Configuration newConfig) {
        mWindow.savePosition(newConfig);
    }

    private AccessibilityTool getAccessibilityTool() {
        return new AccessibilityTool(mContext);
    }

    private String getRunningPackage() {
        if (!TextUtils.isEmpty(mRunningPackage)) {
            return mRunningPackage;
        }
        return getEmptyInfoHint();
    }

    private String getRunningActivity() {
        if (!TextUtils.isEmpty(mRunningActivity)) {
            return mRunningActivity;
        }
        return getEmptyInfoHint();
    }

    private String getEmptyInfoHint() {
        return MessageFormat.format("{0} ({1})",
                mContext.getString(R.string.text_null).toLowerCase(Language.getPrefLanguage().getLocale()),
                mContext.getString(R.string.text_a11y_service_may_be_needed).toLowerCase(Language.getPrefLanguage().getLocale()));
    }

    @Override
    public void onCaptureAvailable(NodeInfo capture, @NonNull Context context) {
        if (mCaptureDeferred != null && mCaptureDeferred.isPending())
            mCaptureDeferred.resolve(capture);
    }

    private void dismissSettingsDialog() {
        if (mSettingsDialog != null) {
            mSettingsDialog.dismiss();
            mSettingsDialog = null;
        }
    }

    @NonNull
    private String getTextAlreadyCopied(int actionResId) {
        return MessageFormat.format("{0} ({1})",
                mContext.getString(R.string.text_already_copied_to_clip),
                mContext.getString(actionResId).toLowerCase(Language.getPrefLanguage().getLocale()));
    }

    public void close() {
        dismissSettingsDialog();
        try {
            mWindow.close();
        } catch (IllegalArgumentException e) {
            e.printStackTrace();
        } finally {
            EventBus.getDefault().post(new StateChangeEvent(STATE_CLOSED, mState));
            mState = STATE_CLOSED;
        }
        mRecorder.removeOnStateChangedListener(this);
        AutoJs.getInstance().getLayoutInspector().removeCaptureAvailableListener(this);
    }

    @Override
    public void onStart() {
        setState(STATE_RECORDING);
    }

    @Override
    public void onStop() {
        setState(STATE_NORMAL);
    }

    @Override
    public void onPause() {
    }

    @Override
    public void onResume() {

    }

}
